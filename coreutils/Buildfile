# Description: Basic file, shell and text manipulation utilities
# URL: http://www.gnu.org/software/coreutils
# License: GPLv3

name=coreutils
version=8.21
release=1
source=(http://ftp.gnu.org/gnu/coreutils/$name-$version.tar.xz
        disable-help2man.patch)
depends=(libcap attr acl gmp)

build() {
   cd $name-$version

   echo "fu_cv_sys_stat_statfs2_bsize=yes" >> config.cache
   echo "gl_cv_func_working_mkstemp=yes" >> config.cache
   echo "ac_cv_func_canonicalize_file_name=no" >> config.cache
   echo "gl_cv_func_working_acl_get_file=yes" >> config.cache

   ./configure --build=$BUILD \
               --host=$HOST \
               --prefix=/usr \
               --libexecdir=/usr/lib \
               --disable-nls \
               --disable-assert \
               --with-gmp \
               --disable-perl \
               --cache-file=config.cache

   # Fix cross compile issue with make-prime-list in version 8.20
   cp -v Makefile{,.orig}
   sed '/src_make_prime_list/d' Makefile.orig > Makefile
   depbase=`echo src/make-prime-list.o | sed 's|[^/]*$|.deps/&|;s|\.o$||'`;\
      gcc -std=gnu99  -I. -I./lib  -Ilib -I./lib -Isrc -I./src  \
      -fdiagnostics-show-option -funit-at-a-time -g -O2 -MT \
      src/make-prime-list.o -MD -MP -MF $depbase.Tpo -c -o src/make-prime-list.o \
      src/make-prime-list.c &&
   mv -f $depbase.Tpo $depbase.Po
   gcc -std=gnu99 -fdiagnostics-show-option -funit-at-a-time -g -O2 \
      -Wl,--as-needed  -o src/make-prime-list src/make-prime-list.o
   cp -v Makefile{,.bak}
   sed -e '/hostname.1/d' Makefile.bak > Makefile

   patch -p1 < $SRC/disable-help2man.patch

   make -j $JOBS
   make DESTDIR=$PKG install
   rm -r $PKG/usr/share
}

